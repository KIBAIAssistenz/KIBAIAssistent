<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>FHNW Lernassistent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* ====== Design Tokens ====== */
    :root{
      --yellow:#f1e60b;
      --yellow-dark:#e6d700;
      --bg:#ffffff;
      --bg-elev:#f7f7f8;
      --text:#11181c;
      --muted:#6b7280;
      --border:#e5e7eb;
      --bubble:#ffffff;
      --bubble-user:#eef1f4;
      --shadow:0 8px 30px rgba(0,0,0,.06);
      --radius:16px;
      --maxw:840px;
    }
    [data-theme="dark"]{
      --bg:#0b0e12;
      --bg-elev:#11151a;
      --text:#eef2f6;
      --muted:#a0a7b4;
      --border:#1f2430;
      --bubble:#0f141a;
      --bubble-user:#121821;
      --shadow:0 8px 30px rgba(0,0,0,.3);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      display:grid;
      grid-template-columns:280px 1fr;
      grid-template-rows:1fr;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      border-right:1px solid var(--border);
      background:var(--bg-elev);
      display:flex;flex-direction:column;
      height:100vh;
      position:sticky; top:0;
    }

    /* FHNW gelber Header in Sidebar */
    .side-header{
      display:flex;align-items:center;gap:10px;
      padding:16px;
      background:var(--yellow);
      color:#000;
      border-bottom:1px solid rgba(0,0,0,0.15);
    }
    [data-theme="dark"] .side-header{
      background:var(--yellow-dark);
      color:#000;
    }

    .brand{height:60px; width: auto;}
    .title{font-weight:700}
    .side-section{padding:16px;border-bottom:1px solid var(--border)}
    .label{font-size:.85rem;color:var(--muted);margin-bottom:8px}
    select, .btn{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);background:var(--bg);color:var(--text);
      font-size:0.95rem;
    }
    .toggle{display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);}
    .switch{
      appearance:none;width:44px;height:26px;border-radius:999px;position:relative;
      background:#d1d5db;outline:none;cursor:pointer;transition:.2s;
    }
    .switch:checked{background:#111827}
    .switch:before{
      content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;
      background:#fff;border-radius:50%;transition:.2s;
    }
    .switch:checked:before{transform:translateX(18px);}

    /* ===== Main ===== */
    .main{display:flex;flex-direction:column;height:100vh;}

    /* FHNW Gelbe Topbar */
    .topbar{
      height:56px;
      display:flex;align-items:center;justify-content:center;
      background:var(--yellow);
      color:#000;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      border:none;
      position:sticky;top:0;z-index:5;
    }
    [data-theme="dark"] .topbar{
      background:var(--yellow-dark);
      color:#000;
    }
    .chip{
      background:rgba(255,255,255,0.8);
      border:none;
      color:#000;
      padding:6px 12px;
      border-radius:999px;
      font-size:.9rem;
      font-weight:600;
    }

    /* Chat Stream */
    .stream{flex:1;overflow-y:auto;padding:24px 12px;display:flex;justify-content:center;}
    .stream-inner{width:100%;max-width:var(--maxw);}
    .msg{
      display:grid;grid-template-columns:68px 1fr;gap:20px;
      padding:18px;border-radius:var(--radius);background:var(--bubble);
      box-shadow:var(--shadow);border:1px solid var(--border);margin:16px 0;
      animation:fadeSlideIn .45s ease forwards;
    }
    .msg.user{background:var(--bubble-user)}
    .avatar{
      height:68px;width:68px;border-radius:50%;display:flex;
      align-items:center;justify-content:center;font-weight:700;
      background:var(--yellow);color:#000;border:1px solid rgba(0,0,0,.08);
    }
    .avatar-bot{
      background:linear-gradient(145deg,#fff 0%, var(--yellow) 100%);
      color:#000;animation:pulse 2.5s infinite;
    }

      .avatar-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(241,230,11,.45)}70%{box-shadow:0 0 0 14px rgba(241,230,11,0)}100%{box-shadow:0 0 0 0 rgba(241,230,11,0)}}
    .msg:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.08);transition:.25s ease;}
    .meta{display:flex;gap:8px;align-items:center;margin-bottom:8px;color:var(--muted);font-size:.88rem;}
    .content{min-height:20px;}

    /* Tables inside chat */
    .content table{
      width:100%;border-collapse:collapse;margin:10px 0;
      font-size:0.95rem;border:1px solid var(--border);
      background:var(--bubble);border-radius:10px;overflow:hidden;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }
    .content th,.content td{
      padding:8px 12px;border:1px solid var(--border);text-align:left;
    }
    .content th{
      background:var(--yellow);color:#000;font-weight:700;
    }
    .content tr:nth-child(even) td{
      background:rgba(0,0,0,0.03);
    }

    /* Markdown basics */
    .content h1,.content h2,.content h3{margin:10px 0 6px}
    .content h1{font-size:1.2rem;border-bottom:2px solid var(--yellow);padding-bottom:2px}
    .content h2{font-size:1.1rem}
    .content h3{font-size:1rem}
    .content p{margin:8px 0}
    .content ul,.content ol{margin:8px 0 8px 20px}
    .content li{margin:4px 0}
    .content strong{font-weight:700}
    .content em{font-style:italic}
    pre{background:var(--bg-elev);border:1px solid var(--border);padding:12px;border-radius:12px;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.92rem}

    /* Typing dots */
    .typing-dots{display:inline-flex;gap:4px;margin-left:6px;vertical-align:middle}
    .typing-dots span{width:6px;height:6px;border-radius:50%;background:#d1c900;animation:td 1.2s infinite}
    .typing-dots span:nth-child(2){animation-delay:.2s}
    .typing-dots span:nth-child(3){animation-delay:.4s}
    @keyframes td{0%,60%,100%{opacity:.2;transform:translateY(0)}30%{opacity:1;transform:translateY(-3px)}}

    /* Composer */
    .composer-wrap{
      position:sticky;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0),var(--bg) 30%);
      padding:14px 12px;display:flex;justify-content:center;
    }
    .composer{
      display:flex;gap:10px;width:100%;max-width:var(--maxw);
      background:var(--bg-elev);border:1px solid var(--border);
      border-radius:999px;padding:8px;box-shadow:var(--shadow);
      transition:box-shadow .3s ease, transform .3s ease;
    }
    .composer:focus-within{box-shadow:0 8px 24px rgba(0,0,0,0.12);transform:scale(1.02);}
    .composer input{
      flex:1;border:none;background:transparent;color:var(--text);
      font-size:1rem;padding:10px 14px;outline:none;
    }
    .send{background:var(--yellow);border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:700;}

    @media(max-width:960px){
      body{grid-template-columns:1fr}
      .sidebar{display:none}
    }

    @keyframes fadeSlideIn{
      0%{opacity:0;transform:translateY(20px) scale(0.97);filter:blur(2px);}
      80%{opacity:0.9;transform:translateY(2px) scale(1.02);}
      100%{opacity:1;transform:translateY(0) scale(1);filter:blur(0);}
    }
  </style>
</head>
<body>
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="side-header">
      <img class="brand" src="{{ url_for('static', filename='fhnw_logo.jpg') }}" alt="FHNW" />
      <div class="title">FHNW Lernassistent</div>
    </div>

    <div class="side-section">
      <div class="label">Modul wählen</div>
      <select id="moduleSelect">
        {% for module in modules %}
          <option value="{{ module }}">{{ module }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="side-section">
      <div class="label">Darstellung</div>
      <div class="toggle">
        <span>Dark Mode</span>
        <input id="themeSwitch" class="switch" type="checkbox" />
      </div>
    </div>

    <div class="side-section">
      <div class="label">Sitzung</div>
      <button class="btn" id="btnNew">+ Neue Unterhaltung</button>
    </div>
  </aside>

  <!-- ===== Main ===== -->
  <main class="main">
    <div class="topbar">
      <div class="chip">Lernmodus</div>
    </div>

    <div class="stream" id="scrollArea">
      <div class="stream-inner" id="stream"></div>
    </div>

    <div class="composer-wrap">
      <form class="composer" onsubmit="event.preventDefault(); sendMessage();">
        <input id="userInput" type="text" placeholder="Frag etwas zu deinem Modul …" autocomplete="off" />
        <button class="send" type="submit">➤</button>
      </form>
    </div>
  </main>

  <script>
    // ===== Dark Mode =====
    const themeSwitch=document.getElementById("themeSwitch");
    const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(prefersDark)document.documentElement.setAttribute('data-theme','dark');
    themeSwitch.checked=document.documentElement.getAttribute('data-theme')==='dark';
    themeSwitch.addEventListener('change',()=>{
      document.documentElement.setAttribute('data-theme',themeSwitch.checked?'dark':'light');
    });

    const stream=document.getElementById("stream");
    const scrollArea=document.getElementById("scrollArea");
    const input=document.getElementById("userInput");

    document.getElementById("btnNew").addEventListener("click",()=>{
      stream.innerHTML="";
      input.focus();
    });

    input.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();sendMessage();}});

    function addMsg(role, innerHTML){
      const wrap=document.createElement("article");
      wrap.className=`msg ${role}`;
      wrap.innerHTML=`
        <div class="avatar ${role==='bot'?'avatar-bot':''}">${role==='bot'
          ? `<img src="{{ url_for('static', filename='chatbot.jpg') }}" alt="Bot" class="avatar-img">`
          : 'S'}
          </div>
        <div>
          <div class="meta">${role==='bot'?'Lernassistent':'Du'}</div>
          <div class="content">${innerHTML}</div>
        </div>`;
      stream.appendChild(wrap);
      scrollToBottom();
      return wrap.querySelector(".content");
    }

    function scrollToBottom(){scrollArea.scrollTop=scrollArea.scrollHeight;}

    async function sendMessage(){
      const message=input.value.trim();
      const module=document.getElementById("moduleSelect").value;
      if(!message)return;

      addMsg("user",escapeHtml(message));
      input.value="";

      const typingContent=addMsg("bot",`<strong>Lernassistent:</strong> <span class="typing-dots"><span></span><span></span><span></span></span>`);

      try{
        const res=await fetch("/ask",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message,module})
        });
        const data=await res.json();

        typingContent.innerHTML=`<strong>Lernassistent:</strong><br><div class="rt"></div>`;
        const container=typingContent.querySelector(".rt");
        typeHTML(container,data.response,9,scrollToBottom);
      }catch(e){
        typingContent.innerHTML=`⚠️ Fehler beim Senden.`;
      }
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // === Typewriter ===
    function typeHTML(target, html, speed=8, onTick){
      html=html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,"");
      let i=0;let buffer="";const tagRegex=/<[^>]*>/g;const tags=[];let match;
      while((match=tagRegex.exec(html))!==null){tags.push({index:match.index,tag:match[0]});}
      let tagIndex=0;
      const timer=setInterval(()=>{
        if(tagIndex<tags.length && i===tags[tagIndex].index){
          buffer+=tags[tagIndex].tag;i+=tags[tagIndex].tag.length;tagIndex++;
        }else{buffer+=html[i]||"";i++;}
        target.innerHTML=buffer;
        if(typeof onTick==="function")onTick();
        if(i>=html.length){clearInterval(timer);}
      },speed);
    }
  </script>
</body>
</html>
