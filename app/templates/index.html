<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>FHNW Lernassistent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Markdown Renderer -->

  <style>
    :root{
      --yellow:#f1e60b;--yellow-dark:#e6d700;
      --bg:#ffffff;--bg-elev:#f7f7f8;
      --text:#11181c;--muted:#6b7280;--border:#e5e7eb;
      --bubble:#ffffff;--bubble-user:#eef1f4;
      --shadow:0 8px 30px rgba(0,0,0,.06);
      --radius:16px;--maxw:840px;
    }
    [data-theme="dark"]{
      --bg:#0b0e12;--bg-elev:#11151a;
      --text:#eef2f6;--muted:#a0a7b4;
      --border:#1f2430;--bubble:#0f141a;
      --bubble-user:#121821;--shadow:0 8px 30px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;transition:background .3s,color .3s,border .3s;}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
    body{display:flex;flex-direction:row;overflow:hidden;}

    /* Sidebar */
    .sidebar{width:280px;flex-shrink:0;border-right:1px solid var(--border);
      background:var(--bg-elev);display:flex;flex-direction:column;height:100vh;position:sticky;top:0;}
    .side-header{display:flex;align-items:center;gap:10px;padding:16px;background:var(--yellow);color:#000;}
    [data-theme="dark"] .side-header{background:var(--yellow-dark);}
    .brand{height:60px;width:auto;}
    .title{font-weight:700;}
    .side-section{padding:16px;border-bottom:1px solid var(--border);}
    .label{font-size:.85rem;color:var(--muted);margin-bottom:8px;}
    select,.btn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--bg);color:var(--text);font-size:0.95rem;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.08);}
    .toggle{display:flex;align-items:center;justify-content:space-between;}
    .switch{appearance:none;width:44px;height:26px;border-radius:999px;position:relative;background:#d1d5db;cursor:pointer;}
    .switch:checked{background:#111827;}
    .switch:before{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;
      border-radius:50%;transition:.2s;}
    .switch:checked:before{transform:translateX(18px);}

    /* Main */
    .main{flex:1;display:flex;flex-direction:column;height:100vh;}
    .topbar{height:56px;display:flex;align-items:center;justify-content:center;
      background:var(--yellow);color:#000;font-weight:600;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
    [data-theme="dark"] .topbar{background:var(--yellow-dark);}
    .stream{flex:1;overflow-y:auto;padding:24px 12px;display:flex;justify-content:center;}
    .stream-inner{width:100%;max-width:var(--maxw);}
    .msg{display:grid;grid-template-columns:68px 1fr;gap:20px;padding:18px;border-radius:var(--radius);
      background:var(--bubble);box-shadow:var(--shadow);border:1px solid var(--border);margin:16px 0;
      opacity:0;transform:translateY(20px);animation:fadeIn .4s forwards;}
    .msg.user{background:var(--bubble-user);}
    .avatar{height:68px;width:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:var(--yellow);color:#000;font-weight:700;}
    .avatar-bot{background:linear-gradient(145deg,#fff 0%, var(--yellow) 100%);}
    .avatar-img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
    .composer-wrap{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0),var(--bg) 30%);
      padding:14px 12px;display:flex;justify-content:center;}
    .composer{display:flex;gap:10px;width:100%;max-width:var(--maxw);
      background:var(--bg-elev);border:1px solid var(--border);border-radius:999px;padding:8px;box-shadow:var(--shadow);}
    .composer input{flex:1;border:none;background:transparent;color:var(--text);
      font-size:1rem;padding:10px 14px;outline:none;}
    .send{background:var(--yellow);border:none;border-radius:999px;padding:10px 14px;
      cursor:pointer;font-weight:700;transition:.2s;}
    .send:hover{transform:scale(1.05);}
    .stars{margin-top:10px;display:flex;align-items:center;gap:4px;}
    .stars span{cursor:pointer;font-size:1.6rem;color:#ccc;transition:transform .15s,color .2s;}
    .stars span:hover{transform:scale(1.2);}
    .stars .active{color:#f1e60b;}
    @keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
    @media(max-width:960px){
      body{flex-direction:column;}
      .sidebar{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border);
        flex-direction:row;align-items:center;justify-content:space-between;}
      .side-section{display:none;}
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="side-header">
      <img class="brand" src="{{ url_for('static', filename='fhnw_logo.jpg') }}" alt="FHNW" />
      <div class="title">FHNW Lernassistent</div>
    </div>
    <div class="side-section">
      <div class="label">Modul wählen</div>
      <select id="moduleSelect">
        {% for module in modules %}
          <option value="{{ module }}">{{ module }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="side-section">
      <div class="label">Darstellung</div>
      <div class="toggle">
        <span>Dark Mode</span>
        <input id="themeSwitch" class="switch" type="checkbox" />
      </div>
    </div>
    <div class="side-section">
      <button class="btn" id="btnNew">+ Neue Unterhaltung</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">Lernmodus</div>
    <div class="stream" id="scrollArea"><div class="stream-inner" id="stream"></div></div>
    <div class="composer-wrap">
      <form class="composer" onsubmit="event.preventDefault(); sendMessage();">
        <input id="userInput" type="text" placeholder="Frag etwas zu deinem Modul …" autocomplete="off" />
        <button class="send" type="submit">➤</button>
      </form>
    </div>
  </main>

  <script>
    // === Dark Mode ===
    const themeSwitch=document.getElementById("themeSwitch");
    const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(prefersDark){document.documentElement.setAttribute('data-theme','dark');themeSwitch.checked=true;}
    themeSwitch.addEventListener('change',()=>document.documentElement.setAttribute('data-theme',themeSwitch.checked?'dark':'light'));

    const stream=document.getElementById("stream");
    const scrollArea=document.getElementById("scrollArea");
    const input=document.getElementById("userInput");
    document.getElementById("btnNew").addEventListener("click",()=>{stream.innerHTML="";input.focus();});

    function addMsg(role, html){
      const wrap=document.createElement("article");
      wrap.className=`msg ${role}`;
      wrap.innerHTML=`
        <div class="avatar ${role==='bot'?'avatar-bot':''}">
          ${role==='bot'?`<img src="{{ url_for('static', filename='chatbot.jpg') }}" class="avatar-img">`:'S'}
        </div>
        <div><div class="meta">${role==='bot'?'Lernassistent':'Du'}</div><div class="content">${html}</div></div>`;
      stream.appendChild(wrap);
      scrollToBottom();
      return wrap.querySelector(".content");
    }

    function scrollToBottom(){scrollArea.scrollTop=scrollArea.scrollHeight;}

    // === Typewriter mit Markdown ===
    function typeMarkdown(target, markdown, speed=12, done){
      const html=marked.parse(markdown);
      const temp=document.createElement("div");
      temp.innerHTML=html;
      const nodes=Array.from(temp.childNodes);
      let i=0;
      function renderNext(){
        if(i<nodes.length){
          target.appendChild(nodes[i].cloneNode(true));
          i++;
          scrollToBottom();
          setTimeout(renderNext,speed*6);
        }else if(done) done();
      }
      renderNext();
    }

    async function sendMessage(){
      const message=input.value.trim();
      const module=document.getElementById("moduleSelect").value;
      if(!message)return;
      addMsg("user",message);
      input.value="";
      const botContent=addMsg("bot","<strong>Lernassistent:</strong> <span class='dots'>...</span>");
      try{
        const res=await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message,module})});
        const data=await res.json();
        botContent.innerHTML="<strong>Lernassistent:</strong><br><div class='rt'></div>";
        const container=botContent.querySelector(".rt");
        typeMarkdown(container,data.response,10,()=>addStars(botContent,message,data.response));
      }catch{botContent.innerHTML="⚠️ Fehler beim Senden.";}
    }

    function addStars(container,message,response){
      const stars=document.createElement("div");
      stars.className="stars";
      stars.innerHTML=[1,2,3,4,5].map(i=>`<span data-val="${i}">★</span>`).join("");
      container.appendChild(stars);
      stars.querySelectorAll("span").forEach(star=>{
        star.addEventListener("mouseenter",()=>{
          const val=parseInt(star.dataset.val);
          stars.querySelectorAll("span").forEach(s=>s.style.color=parseInt(s.dataset.val)<=val?"#f1e60b":"#ccc");
        });
        star.addEventListener("click",async()=>{
          const rating=parseInt(star.dataset.val);
          stars.querySelectorAll("span").forEach(s=>s.classList.toggle("active",parseInt(s.dataset.val)<=rating));
          await fetch("/feedback",{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({user_id:"student_ui",message,response,rating})});
          stars.insertAdjacentHTML("beforeend","<span style='margin-left:8px;font-size:0.9rem;'>Danke ✅</span>");
        });
      });
    }
  </script>
</body>
</html>
